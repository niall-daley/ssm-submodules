#!/bin/bash

set -o errexit
set -o xtrace

. $(dirname $0)/vars

PACKAGES=${packages[@]}

usage () {
    cat <<EOF
Usage: $0 [OPTIONS] [PACKAGES]

    The following options may be given:
        --help) usage ;;

    The following packages may be given:
        ${packages[@]}

Example $0 ssm-client ssm-dashboards
EOF
        exit 1
}

shell_quote_string() {
  echo "$1" | sed -e 's,\([^a-zA-Z0-9/_.=-]\),\\\1,g'
}

build_rpms() {
    local build_commands=

    for package in ${PACKAGES[@]}; do
        build_commands="
            ${build_commands}
            /home/builder/ssm-submodules/build/bin/build-rpm ${package}
        "
    done

    docker run --privileged -e ENV_DEV --rm -v ${root_dir}:/home/builder/ssm-submodules-copy ${rpmbuild_docker_image} sh -c "
        set -o errexit
        set -o xtrace
 
        cp -r /home/builder/ssm-submodules-copy /home/builder/ssm-submodules
        ${build_commands}

        # give host user permission
        rsync -aO --no-owner --no-group --no-perms /home/builder/ssm-submodules/results/ /home/builder/ssm-submodules-copy/results/
        rsync -aO --no-owner --no-group --no-perms /home/builder/ssm-submodules/logs/ /home/builder/ssm-submodules-copy/logs/
        rsync -aO --no-owner --no-group --no-perms /home/builder/ssm-submodules/docs/ /home/builder/ssm-submodules-copy/docs/
        find /home/builder/ssm-submodules-copy/{results,logs,docs} -type d -exec chmod 0777 {} \;
        find /home/builder/ssm-submodules-copy/{results,logs,docs} -type f ! -executable -exec chmod 0666 {} \;
    "
}

main() {
    declare -a TMP_PACKAGES

    for arg do
        val=`echo "$arg" | sed -e 's;^--[^=]*=;;'`
        case "$arg" in
            --help)         usage ;;
            -*)             usage ;;
            *)              TMP_PACKAGES+=(`shell_quote_string "$arg"`) ;;
        esac
    done

    if [ ${#TMP_PACKAGES[@]} -gt 0 ]; then
        PACKAGES=${TMP_PACKAGES[@]}
    fi
    
    if [[ -n "${WITHOUT_DOCKER}" ]] && [[ ${WITHOUT_DOCKER} -eq 1 ]]; then
        for package in ${PACKAGES[@]}; do
            "${bin_dir}/build-rpm" $package
        done
    else
        # give docker container user permission
        mkdir -vp ${root_dir}/{results,docs,logs}
        find ${root_dir}/{results,logs,docs} -type d -exec chmod 0777 {} \;
        find ${root_dir}/{results,logs,docs} -type f ! -executable -exec chmod 0666 {} \;

        build_rpms
    fi
}

main $@